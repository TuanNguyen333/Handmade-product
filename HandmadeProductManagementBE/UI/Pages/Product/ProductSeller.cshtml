@page
@model UI.Pages.Product.ProductSellerModel
@{
    ViewData["Title"] = "Product Seller List";
}
@Html.AntiForgeryToken()

<h1 class="text-3xl font-bold mb-4">Product List</h1>

<div class="search-filter">
    <form method="get" class="flex space-x-4 items-center">
        <input class="border border-gray-300 rounded-md p-2" type="text" name="Name" placeholder="Search by name" value="@Request.Query["Name"]" onchange="this.form.submit();" />
        <select name="CategoryId" class="border border-gray-300 rounded-md p-2">
            <option value="">Select Category</option>
            @if (Model.Categories != null && Model.Categories.Any())
            {
                foreach (var category in Model.Categories)
                {
                    var isSelected = Request.Query["CategoryId"] == category.Id.ToString();
                    if (isSelected)
                    {
                        <option value="@category.Id" selected>@category.Name</option>
                    }
                    else
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                }
            }
        </select>
        @{
            var selectedStatus = Request.Query["Status"].ToString();
        }

        <select name="Status" class="border border-gray-300 rounded-md p-2">
            @if (string.IsNullOrEmpty(selectedStatus))
            {
                <option value="" selected>Select Status</option>
            }
            else
            {
                <option value="">Select Status</option>
            }

            @if (selectedStatus == "Available")
            {
                <option value="Available" selected>Available</option>
            }
            else
            {
                <option value="Available">Available</option>
            }

            @if (selectedStatus == "OutOfStock")
            {
                <option value="OutOfStock" selected>Out Of Stock</option>
            }
            else
            {
                <option value="OutOfStock">Out Of Stock</option>
            }
        </select>
        <input class="border border-gray-300 rounded-md p-2" type="number" name="MinRating" placeholder="Min Rating" min="0" max="5" value="@Request.Query["MinRating"]" />

        <div class="flex items-center space-x-4">
            <label class="flex items-center">
                <input type="radio" id="sortByPrice" name="SortOption" value="SortByPrice"
                @(Request.Query["SortOption"] == "SortByPrice" ? "checked" : "") onchange="this.form.submit();" />
                <span class="ml-2">Sort by Price</span>
            </label>

            <label class="flex items-center">
                <input type="radio" id="sortByRating" name="SortOption" value="SortByRating"
                @(Request.Query["SortOption"] == "SortByRating" ? "checked" : "") onchange="this.form.submit();" />
                <span class="ml-2">Sort by Rating</span>
            </label>
        </div>



        <label class="flex items-center">
            <span class="mr-2">Sort Descending:</span>
            <input type="checkbox" name="sortDescending" value="true"
            @(Request.Query["SortDescending"] == "true" ? "checked" : "") onchange="this.form.submit();" />
        </label>

        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Search</button>
        <button type="button" onclick="openAddProductModal()"
                class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">
            Add Product
        </button>
    </form>
</div>

<!-- Product List -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-8">
    @if (Model.Products != null && Model.Products.Any())
    {
        foreach (var product in Model.Products)
        {
            <div class="border rounded-lg shadow-md p-4">
                <div class="aspect-w-1 aspect-h-1 mb-4">
                    @if (!string.IsNullOrEmpty(product.ProductImageUrl))
                    {
                        <img src="@product.ProductImageUrl" alt="@product.Name" class="object-cover rounded-md w-full h-48" />
                    }
                    else
                    {
                        <div class="bg-gray-200 rounded-md w-full h-48 flex items-center justify-center">
                            <span class="text-gray-500">No image</span>
                        </div>
                    }
                </div>
                <h3 class="text-lg font-semibold">@product.Name</h3>
                @*                 <p class="text-gray-600 text-sm mb-2">@product.Category?.Name</p>
        *@                <p class="text-gray-800 font-medium">$@product.LowestPrice.ToString("F2")</p>
                <div class="flex items-center mt-2">
                    <span class="text-yellow-400">★</span>
                    <span class="ml-1">@product.Rating.ToString("F1")</span>
                    @*                     <span class="text-gray-500 ml-2">(@product.ReviewCount reviews)</span>
            *@
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <div class="text-sm text-gray-500 mt-2">
                        <span id="status-label-@product.Id" class="px-2 py-1 rounded-full text-sm @(product.Status == "Available" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")">@product.Status</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="toggleProductStatus('@product.Id', '@product.Status', this)"
                                class="@(product.Status == "Available" ? "bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-md" : "bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md")">
                            @(product.Status == "Available" ? "Deactivate" : "Activate")
                        </button>
                        <button onclick="editProduct('@product.Id')"
                                class="bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">
                            Edit
                        </button>
                        <button onclick="deleteProduct('@product.Id')"
                                class="bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-span-full text-center py-8">
            <p class="text-gray-500">No products found.</p>
        </div>
    }
</div>

@{
    var paginationModel = new UI.Pages.Shared.PaginationModel
            {
                PageNumber = Model.PageNumber,
                PageSize = Model.PageSize
            };
}

<partial name="~/Pages/Shared/_Pagination.cshtml" model="paginationModel" />

<!-- Add Product Modal -->
<div id="addProductModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="modal-content relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 text-center">Add New Product</h3>
            <form id="addProductForm" class="mt-4">
                @Html.AntiForgeryToken()
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="productName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                        <div class="text-red-500" id="nameError"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="categoryId"
                                onchange="loadVariations(this.value)"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">Select Category</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <div class="text-red-500" id="categoryError"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="productDescription"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                  rows="3"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Images</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <input type="file" multiple accept="image/*"
                                       id="productImages" class="hidden" />
                                <label for="productImages"
                                       class="cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                    Upload Images
                                </label>
                            </div>
                        </div>
                        <div id="imagePreviewContainer" class="grid grid-cols-4 gap-4 mt-4"></div>
                    </div>
                </div>

                <div id="variationsContainer" class="mt-4">
                    <h4 class="text-lg font-medium mb-2">Variations</h4>
                    <div id="existingVariations"></div>
                </div>

                <div id="variationCombinationsContainer" class="mt-4">
                    <h4 class="text-lg font-medium mb-2">Variation Combinations</h4>
                    <div id="combinationsList"></div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">
                        Create Product
                    </button>
                    <button type="button" onclick="closeAddProductModal()"
                            class="ml-2 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="editProductModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="modal-content relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 text-center">Edit Product</h3>
            <form id="editProductForm" class="mt-4">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editProductId" />
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="editProductName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                        <div class="text-red-500" id="editNameError"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="editCategoryId"
                                onchange="loadVariations(this.value)"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">Select Category</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <div class="text-red-500" id="editCategoryError"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="editProductDescription"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                  rows="3"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Images</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <input type="file" multiple accept="image/*"
                                       id="editProductImages" class="hidden" />
                                <label for="editProductImages"
                                       class="cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                    Upload Images
                                </label>
                            </div>
                        </div>
                        <div id="editImagePreviewContainer" class="grid grid-cols-4 gap-4 mt-4"></div>
                    </div>
                </div>

                <div id="editVariationsContainer" class="mt-4">
                    <h4 class="text-lg font-medium mb-2">Variations</h4>
                    <div id="editExistingVariations"></div>
                </div>

                <div id="editVariationCombinationsContainer" class="mt-4">
                    <h4 class="text-lg font-medium mb-2">Variation Combinations</h4>
                    <div id="editCombinationsList"></div>
                </div>

                <div class="mt-4 flex justify-between">
                    <div>
                        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
                            Save Changes
                        </button>
                        <button type="button" onclick="document.getElementById('editProductModal').classList.add('hidden')"
                                class="ml-2 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openAddProductModal() {
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.classList.remove('hidden');
                // Reset form
                document.getElementById('addProductForm').reset();
                document.getElementById('imagePreviewContainer').innerHTML = '';
                document.getElementById('existingVariations').innerHTML = '';
                document.getElementById('combinationsList').innerHTML = '';
            }
        }

        function closeAddProductModal() {
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Optional: Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('addProductModal');
            if (event.target === modal) {
                closeAddProductModal();
            }
        }

        async function loadVariations(categoryId) {
            if (!categoryId) {
                console.warn('No category ID provided');
                return;
            }

            try {
                const response = await fetch(`?handler=VariationsByCategory&categoryId=${categoryId}`, {
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const variations = await response.json();
                console.log('Variations response:', variations); // Debug log

                // Clear existing variations container
                const variationsContainer = document.getElementById('existingVariations');
                if (!variationsContainer) {
                    console.warn('Variations container not found');
                    return;
                }

                if (!variations || variations.length === 0) {
                    variationsContainer.innerHTML = '<p class="text-gray-500">No variations available for this category.</p>';
                    return;
                }

                // Render variations and their options
                const variationsHtml = variations.map(variation => `
                            <div class="mb-4 p-3 border rounded" data-variation-id="${variation.id}">
                                <strong>${variation.name || 'Unnamed Variation'}</strong>
                                <div class="mt-2">
                                    ${variation.variationOptions && variation.variationOptions.length > 0 ?
                        variation.variationOptions.map(option => `
                                            <div class="form-check">
                                                <input type="checkbox"
                                                       class="form-check-input variation-option"
                                                       id="option_${option.id}"
                                                       value="${option.id}"
                                                       data-variation-id="${variation.id}"
                                                       data-option-value="${option.value}">
                                                <label class="form-check-label" for="option_${option.id}">
                                                    ${option.value}
                                                </label>
                                            </div>
                                        `).join('')
                        : '<p class="text-gray-500">No options available</p>'}
                                </div>
                            </div>
                        `).join('');

                variationsContainer.innerHTML = variationsHtml;

                // Add event listeners to checkboxes
                document.querySelectorAll('.variation-option').forEach(checkbox => {
                    checkbox.addEventListener('change', updateVariationCombinations);
                });

                // Initialize combinations container
                updateVariationCombinations();

            } catch (error) {
                console.error('Error loading variations:', error);
                const variationsContainer = document.getElementById('existingVariations');
                if (variationsContainer) {
                    variationsContainer.innerHTML = '<p class="text-red-500">Error loading variations. Please try again.</p>';
                }
            }
        }

        function displayExistingVariations(variations) {
            const container = document.getElementById('existingVariations');
            if (!container) return;

            if (!variations || variations.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No variations found for this category.</p>';
                return;
            }

            container.innerHTML = variations.map(variation => `
                                <div class="mb-4 p-3 border rounded">
                                    <strong>${variation.name || 'Unnamed Variation'}</strong>
                                    <div class="mt-2">
                                        <input type="text"
                                            class="w-full rounded-md border-gray-300 shadow-sm"
                                            placeholder="Enter values (comma-separated)"
                                            data-variation-id="${variation.id}"
                                            onchange="handleVariationValueChange(this)"/>
                                    </div>
                                </div>
                            `).join('');
        }

        function updateVariationCombinations() {
            const selectedOptions = {};
            const optionLabels = {};

            // Collect all selected options and their labels
            document.querySelectorAll('.variation-option:checked').forEach(checkbox => {
                const variationId = checkbox.getAttribute('data-variation-id');
                if (!selectedOptions[variationId]) {
                    selectedOptions[variationId] = [];
                }
                selectedOptions[variationId].push(checkbox.value);
                optionLabels[checkbox.value] = checkbox.getAttribute('data-option-value');
            });

            // Generate combinations
            const combinations = generateCombinations(selectedOptions);

            // Update combinations display
            const combinationsContainer = document.getElementById('combinationsList');
            if (!combinationsContainer) return;

            if (combinations.length === 0) {
                combinationsContainer.innerHTML = '<p class="text-gray-500">Select variation options to create combinations</p>';
                return;
            }

            const combinationsHtml = combinations.map((combination, index) => `
                        <div class="mb-4 p-3 border rounded">
                            <div class="flex items-center justify-between">
                                <div class="flex-grow">
                                    <p class="font-medium">Combination ${index + 1}:</p>
                                    <p class="text-sm text-gray-600">
                                        ${combination.map(optionId => optionLabels[optionId]).join(' / ')}
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <input type="number"
                                           class="w-32 rounded-md border-gray-300 shadow-sm"
                                           placeholder="Price"
                                           min="0"
                                           step="0.01"
                                           onchange="updateCombinationData(${index}, 'price', this.value)">
                                    <input type="number"
                                           class="w-32 rounded-md border-gray-300 shadow-sm"
                                           placeholder="Stock"
                                           min="0"
                                           onchange="updateCombinationData(${index}, 'stock', this.value)">
                                </div>
                            </div>
                        </div>
                    `).join('');

            combinationsContainer.innerHTML = combinationsHtml;

            // Update hidden field with combination data
            updateHiddenCombinationsField(combinations);
        }

        function updateHiddenCombinationsField(combinations) {
            // Create hidden input if it doesn't exist
            let hiddenField = document.getElementById('combinationsJson');
            if (!hiddenField) {
                hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.id = 'combinationsJson';
                document.getElementById('addProductForm').appendChild(hiddenField);
            }
            hiddenField.value = JSON.stringify(combinations.map(combo => ({
                variationOptionIds: combo,
                price: 0,
                quantityInStock: 0
            })));
        }

        function generateCombinations(selectedOptions) {
            const variations = Object.values(selectedOptions);
            if (variations.length === 0) return [];

            return variations.reduce((acc, curr) => {
                if (acc.length === 0) return curr.map(x => [x]);
                return acc.flatMap(x => curr.map(y => [...x, y]));
            }, []);
        }

        function displayCombinations(combinations, container) {
            if (combinations.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No combinations available</p>';
                return;
            }

            const combinationsHtml = combinations.map((combo, index) => `
                                        <div class="mb-2 p-2 border rounded flex justify-between items-center">
                                            <div>
                                                ${Object.entries(combo).map(([name, value]) =>
                `<span class="mr-2"><strong>${name}:</strong> ${value}</span>`
            ).join('')}
                                            </div>
                                            <div>
                                                <input type="number"
                                                       placeholder="Price"
                                                       class="w-24 rounded-md border-gray-300 shadow-sm mr-2"
                                                       onchange="updateCombinationData(${index}, 'price', this.value)"/>
                                                <input type="number"
                                                       placeholder="Stock"
                                                       class="w-24 rounded-md border-gray-300 shadow-sm"
                                                       onchange="updateCombinationData(${index}, 'stock', this.value)"/>
                                            </div>
                                        </div>
                                    `).join('');

            container.innerHTML = combinationsHtml;
        }

        // Function to handle variation combinations
        function updateCombinationData(index, field, value) {
            const combinations = JSON.parse(document.getElementById('combinationsJson').value || '[]');

            // Ensure the combination exists
            if (!combinations[index]) {
                combinations[index] = {
                    variationOptionIds: [],
                    price: 0,
                    quantityInStock: 0
                };
            }

            // Update the field
            if (field === 'price') {
                combinations[index].price = parseInt(value) || 0;
            } else if (field === 'stock') {
                combinations[index].quantityInStock = parseInt(value) || 0;
            }

            document.getElementById('combinationsJson').value = JSON.stringify(combinations);
        }

        async function uploadImagesSequentially(productId, files) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const results = [];

            // Use a single FormData instance for all images
            const formData = new FormData();
            files.forEach(file => {
                formData.append('productImages', file); // Append all images to a single FormData
            });

            try {
                const response = await fetch(`?handler=UploadImages&productId=${productId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': token
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                results.push(result);
                console.log(`Successfully uploaded ${files.length} images.`);
            } catch (error) {
                console.error(`Error uploading images:`, error);
                results.push({ error: error.message });
            }

            return {
                success: results.some(r => !r.error),
                totalAttempted: files.length,
                successfulUploads: results.filter(r => !r.error).length,
                failedUploads: results.filter(r => r.error).length,
                details: results
            };
        }

        async function handleFormSubmission(e) {
            e.preventDefault();

            // Clear previous errors
            document.getElementById('nameError').textContent = '';
            document.getElementById('categoryError').textContent = '';

            // Get form data
            const productData = {
                name: document.getElementById('productName').value.trim(),
                categoryId: document.getElementById('categoryId').value.trim(),
                description: document.getElementById('productDescription').value.trim(),
                variations: getSelectedVariations(),
                variationCombinations: getVariationCombinations()
            };

            // Basic validation
            if (!productData.name) {
                document.getElementById('nameError').textContent = 'Product Name is required';
                return;
            }
            if (!productData.categoryId) {
                document.getElementById('categoryError').textContent = 'Category is required';
                return;
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                // Create product
                const createResponse = await fetch('?handler=CreateProduct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(productData)
                });

                const result = await createResponse.json();

                if (!createResponse.ok) {
                    throw new Error(result.error || 'Failed to create product');
                }

                // Get product ID from the response
                const productId = result.productId;

                // Handle image uploads if there are any
                const imageInput = document.getElementById('productImages');
                if (imageInput?.files?.length > 0) {
                    const uploadResult = await uploadImagesSequentially(productId, Array.from(imageInput.files));

                    if (uploadResult.successfulUploads > 0) {
                        const message = `Product created successfully!\n` +
                            `${uploadResult.successfulUploads} out of ${uploadResult.totalAttempted} images uploaded.`;
                        if (uploadResult.failedUploads > 0) {
                            message += `\n${uploadResult.failedUploads} images failed to upload.`;
                        }
                        alert(message);
                    } else {
                        alert('Product created but image uploads failed. Please try uploading images again.');
                    }
                } else {
                    alert('Product created successfully!');
                }

                // Reload page after completion
                window.location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while creating the product');
            }
        }

        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';

            Array.from(files).forEach(file => {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    console.error(`Invalid file type: ${file.type}`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = 'relative';
                    div.innerHTML = `
                        <img src="${e.target.result}"
                             class="w-full h-24 object-cover rounded-md"
                             alt="${file.name}"
                             title="${file.name}"/>
                        <button type="button"
                                onclick="removeImagePreview(this)"
                                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center">
                            ×
                        </button>
                    `;
                    container.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImagePreview(button) {
            const imageContainer = button.parentElement;
            imageContainer.remove();

            // Note: Since we can't directly modify FileList,
            // we'll need to handle the actual file removal during form submission
        }

        function getSelectedVariations() {
            const variations = [];
            document.querySelectorAll('.variation-item').forEach(item => {
                const variationId = item.dataset.variationId;
                const selectedOptions = Array.from(item.querySelectorAll('.variation-option:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedOptions.length > 0) {
                    variations.push({
                        id: variationId,
                        variationOptionIds: selectedOptions
                    });
                }
            });
            return variations;
        }

        function getVariationCombinations() {
            const combinations = [];
            document.querySelectorAll('#combinationsList > div').forEach(combo => {
                const priceInput = combo.querySelector('input[placeholder="Price"]');
                const stockInput = combo.querySelector('input[placeholder="Stock"]');
                const optionIds = Array.from(combo.querySelectorAll('.selected-option'))
                    .map(option => option.dataset.optionId);

                combinations.push({
                    variationOptionIds: optionIds,
                    price: parseFloat(priceInput.value) || 0,
                    quantityInStock: parseInt(stockInput.value) || 0
                });
            });
            return combinations;
        }

        // Edit Product Functions
        async function editProduct(productId) {
            const modal = document.getElementById('editProductModal');
            modal.classList.remove('hidden');
            document.getElementById('editProductId').value = productId;

            try {
                // Fetch product details
                const response = await fetch(`?handler=ProductDetails&id=${productId}`, {
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const product = await response.json();

                // Populate basic form fields
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductDescription').value = product.description;
                document.getElementById('editCategoryId').value = product.categoryId;

                // Load variations for the category and then set selected options
                await loadVariationsForEdit(product.categoryId, product.variations);

                // Display existing images
                const imageContainer = document.getElementById('editImagePreviewContainer');
                imageContainer.innerHTML = '';
                if (product.productImages && product.productImages.length > 0) {
                    product.productImages.forEach(image => {
                        const div = document.createElement('div');
                        div.className = 'relative';
                        div.innerHTML = `
                            <img src="${image.url}" class="w-full h-24 object-cover rounded-md" />
                            <button type="button" onclick="deleteProductImage('${image.id}')"
                                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center">
                                ×
                            </button>
                        `;
                        imageContainer.appendChild(div);
                    });
                }

                // Update combinations if they exist
                if (product.variationCombinations && product.variationCombinations.length > 0) {
                    displayExistingCombinations(product.variationCombinations);
                }
            } catch (error) {
                console.error('Error loading product details:', error);
                alert('Failed to load product details');
            }
        }

        async function loadVariationsForEdit(categoryId, existingVariations) {
            if (!categoryId) return;

            try {
                const response = await fetch(`?handler=VariationsByCategory&categoryId=${categoryId}`, {
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const variations = await response.json();
                const variationsContainer = document.getElementById('editExistingVariations');

                if (!variationsContainer) return;

                if (!variations || variations.length === 0) {
                    variationsContainer.innerHTML = '<p class="text-gray-500">No variations available for this category.</p>';
                    return;
                }

                // Render variations with existing selections
                const variationsHtml = variations.map(variation => `
                    <div class="mb-4 p-3 border rounded" data-variation-id="${variation.id}">
                        <strong>${variation.name || 'Unnamed Variation'}</strong>
                        <div class="mt-2">
                            ${variation.variationOptions && variation.variationOptions.length > 0 ?
                        variation.variationOptions.map(option => {
                            const isSelected = existingVariations?.some(v =>
                                v.variationId === variation.id &&
                                v.variationOptionId === option.id
                            );
                            return `
                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="form-check-input variation-option"
                                               id="edit_option_${option.id}"
                                               value="${option.id}"
                                               data-variation-id="${variation.id}"
                                               data-option-value="${option.value}"
                                               ${isSelected ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_option_${option.id}">
                                            ${option.value}
                                        </label>
                                    </div>
                                `;
                        }).join('')
                        : '<p class="text-gray-500">No options available</p>'}
                        </div>
                    </div>
                `).join('');

                variationsContainer.innerHTML = variationsHtml;

                // Add event listeners to checkboxes
                document.querySelectorAll('#editExistingVariations .variation-option').forEach(checkbox => {
                    checkbox.addEventListener('change', updateEditVariationCombinations);
                });

                // Initialize combinations container
                updateEditVariationCombinations();

            } catch (error) {
                console.error('Error loading variations:', error);
                const variationsContainer = document.getElementById('editExistingVariations');
                if (variationsContainer) {
                    variationsContainer.innerHTML = '<p class="text-red-500">Error loading variations. Please try again.</p>';
                }
            }
        }

        async function saveProductChanges() {
            const productId = document.getElementById('editProductId').value;
            const formData = new FormData();

            // Add basic product info
            formData.append('Name', document.getElementById('editProductName').value);
            formData.append('Description', document.getElementById('editProductDescription').value);
            formData.append('CategoryId', document.getElementById('editCategoryId').value);

            // Add variation combinations
            const combinations = getVariationCombinations();
            formData.append('VariationCombinations', JSON.stringify(combinations));

            // Add new images
            const imageInput = document.getElementById('editProductImages');
            if (imageInput.files.length > 0) {
                Array.from(imageInput.files).forEach(file => {
                    formData.append('ProductImages', file);
                });
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch(`?handler=UpdateProduct&id=${productId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to update product');
                }

                alert('Product updated successfully!');
                window.location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the product');
            }
        }

        function updateEditVariationCombinations() {
            const selectedOptions = {};
            const optionLabels = {};

            document.querySelectorAll('#editExistingVariations .variation-option:checked').forEach(checkbox => {
                const variationId = checkbox.getAttribute('data-variation-id');
                if (!selectedOptions[variationId]) {
                    selectedOptions[variationId] = [];
                }
                selectedOptions[variationId].push(checkbox.value);
                optionLabels[checkbox.value] = checkbox.getAttribute('data-option-value');
            });

            const combinations = generateCombinations(selectedOptions);
            const combinationsContainer = document.getElementById('editCombinationsList');

            if (!combinationsContainer) return;

            if (combinations.length === 0) {
                combinationsContainer.innerHTML = '<p class="text-gray-500">Select variation options to create combinations</p>';
                return;
            }

            const combinationsHtml = combinations.map((combination, index) => `
                <div class="mb-4 p-3 border rounded">
                    <div class="flex items-center justify-between">
                        <div class="flex-grow">
                            <p class="font-medium">Combination ${index + 1}:</p>
                            <p class="text-sm text-gray-600">
                                ${combination.map(optionId => optionLabels[optionId]).join(' / ')}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <input type="number"
                                   class="w-32 rounded-md border-gray-300 shadow-sm"
                                   placeholder="Price"
                                   min="0"
                                   step="0.01">
                            <input type="number"
                                   class="w-32 rounded-md border-gray-300 shadow-sm"
                                   placeholder="Stock"
                                   min="0">
                        </div>
                    </div>
                </div>
            `).join('');

            combinationsContainer.innerHTML = combinationsHtml;
        }

        // Function to display existing combinations with their values
        function displayExistingCombinations(combinations) {
            const container = document.getElementById('editCombinationsList');
            if (!container) return;

            const combinationsHtml = combinations.map((combo, index) => `
                <div class="mb-4 p-3 border rounded">
                    <div class="flex items-center justify-between">
                        <div class="flex-grow">
                            <p class="font-medium">Combination ${index + 1}:</p>
                            <p class="text-sm text-gray-600">
                                ${combo.optionNames.join(' / ')}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <input type="number"
                                   class="w-32 rounded-md border-gray-300 shadow-sm"
                                   placeholder="Price"
                                   min="0"
                                   step="0.01"
                                   value="${combo.price}">
                            <input type="number"
                                   class="w-32 rounded-md border-gray-300 shadow-sm"
                                   placeholder="Stock"
                                   min="0"
                                   value="${combo.stock}">
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = combinationsHtml;
        }

        async function toggleProductStatus(productId, currentStatus, button) {
            try {
                const isAvailable = currentStatus === "Available" ? false : true;
                const response = await fetch(`?handler=ToggleProductStatus&productId=${productId}&isAvailable=${isAvailable}`, {
                    method: 'POST',
                    headers: {
                        '__RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const data = await response.json();
                if (data.success) {
                    // Update the product status label and button text immediately
                    const statusLabel = document.getElementById(`status-label-${productId}`);
                    const newStatus = isAvailable ? "Available" : "Unavailable";
                    statusLabel.textContent = newStatus;

                    // Update the status label class for color change
                    if (isAvailable) {
                        statusLabel.classList.remove("bg-red-100", "text-red-800");
                        statusLabel.classList.add("bg-green-100", "text-green-800");
                    } else {
                        statusLabel.classList.remove("bg-green-100", "text-green-800");
                        statusLabel.classList.add("bg-red-100", "text-red-800");
                    }

                    // Update the button text and style
                    button.textContent = isAvailable ? "Deactivate" : "Activate";
                    button.className = isAvailable ? "bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-md"
                        : "bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md";

                    // Update the button's currentStatus value for next toggle
                    button.setAttribute("onclick", `toggleProductStatus('${productId}', '${newStatus}', this)`);
                } else {
                    alert(data.error || 'Failed to update product status');
                }
            } catch (error) {
                console.error('Error details:', error);
                alert('An unexpected error occurred while updating the product status.');
            }
        }

        // Delete Product Function
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch(`?handler=DeleteProduct&id=${productId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }

                alert('Product deleted successfully!');
                window.location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting the product');
            }
        }

        // Delete Product Image Function
        async function deleteProductImage(imageId) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch(`?handler=DeleteProductImage&imageId=${imageId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete image');
                }

                // Remove image from UI
                const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
                if (imageElement) {
                    imageElement.remove();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting the image');
            }
        }

        // Add event listeners when document is ready
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('addProductForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmission);
            }

            // Image preview handler
            const imageInput = document.getElementById('productImages');
            if (imageInput) {
                imageInput.addEventListener('change', handleImageUpload);
            }
        });
    </script>
}